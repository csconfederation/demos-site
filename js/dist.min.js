function FileList(a,b){var c=$(a),d=$(c.find("Prefix")[0]).text(),e=$.map(c.find("CommonPrefixes"),function(a){return new Directory($(a))}).sortBy("title","desc"),f=$.map(c.find("Contents"),function(a){return new File(d,$(a),b)}),g=$("#rowTemplate").text(),h=function(a){for(var b,c=g;b=/{{(\w+)}}/.exec(c);)c=c.replace(b[0],a[b[1]]||"");return c};this.sortBy=function(a,b){f=f.sortBy(a,b)},this.render=function(a){var b=[];d&&b.push(new ParentDirectory(d)),b=b.concat(e,f),a.html("").parent().show(),b.forEach(function(b){b.name&&a.append(h(b))})}}function File(a,b,c){var d=b.find("Key").text(),e=d.substring(a.length);return{icon:"ion-document-text",name:e,title:e.replace(/^The\s*/i,""),href:c+escape(d),date:new Date(b.find("LastModified").text()).toLocaleString(),size:parseInt(b.find("Size").text()).toBytes()}}function Directory(a){var b=a.find("Prefix").text(),c=b.split("/").slice(-2).join("/");return{icon:"ion-ios7-folder",name:c,title:c.replace(/^The\s*/i,""),href:location.pathname+"?path="+escape(b),size:"-"}}function ParentDirectory(a){var b=a.replace(/\/$/,"").split("/").slice(0,-1).concat("").join("/");return{icon:"ion-arrow-return-left",name:"../",href:location.pathname+"?path="+escape(b)}}Number.prototype.toBytes=function(){if(0===this)return"0 bytes";var a=parseInt(Math.floor(Math.log(this)/Math.log(1024))),b=Math.round(this/Math.pow(1024,a)*10)/10;return[b,["bytes","KB","MB","GB","TB"][a]].join(" ")},Array.prototype.sortBy=function(a,b){var c="asc"===b;return this.sort(function(b,d){return b[a]<d[a]?c?1:-1:b[a]>d[a]?c?-1:1:0})};var decrypt=function(a,b){try{var c=CryptoJS.AES.decrypt(a,b);return c.toString(CryptoJS.enc.Utf8)}catch(d){}},KeyStore={setCookie:function(a){document.cookie="decryptKey="+a+"; path=/"},readCookie:function(){for(var a="decryptKey=",b=document.cookie.split(";"),c=0;c<b.length;c++){for(var d=b[c];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null},eraseCookie:function(){var a="expires="+new Date(0).toUTCString();document.cookie="decryptKey=;"+a+"; path=/"}},buildS3Url=function(a){var b=a+"?delimiter=/",c=/.*[?&]path=([^&]+)(&.*)?$/,d=location.search.match(c);if(d){var e=d[1].replace(/\/$/,"")+"/";b+="&prefix="+e}return b},loadS3Bucket=function(a,b){a?$.get(buildS3Url(a)).done(b.success).fail(b.failure):b.failure()};$(function(a){var b,c=function(c,d){a("#loading, #login").hide(),b=new FileList(c,d),a(".sortable.active").click()};a(".sortable").click(function(c){var d=a(this),e=d.attr("data-dir");b.sortBy(d.attr("data-field"),e),b.render(a("#items tbody")),a(".sortable").removeClass("active"),d.addClass("active"),d.attr("data-dir","asc"===e?"desc":"asc")}),a("#login").submit(function(b){var e=a(this).find("input").val(),f=decrypt(window.SECRET_BUCKET_URL,e);return a("#login").hide(),a("#loading").show(),loadS3Bucket(f,{success:function(a){KeyStore.setCookie(e),c(a,f)},failure:function(a){alert("Incorrect Password"),d()}}),!1});var d=function(){if(window.SECRET_BUCKET_URL)if(KeyStore.readCookie()){var b=decrypt(window.SECRET_BUCKET_URL,KeyStore.readCookie());loadS3Bucket(b,{success:function(a){c(a,b)},failure:function(a){KeyStore.eraseCookie(),d()}})}else a("#loading").hide(),a("#login").show().find("input").focus();else loadS3Bucket(window.S3_BUCKET_URL,{success:function(a){c(a,window.S3_BUCKET_URL)},failure:function(a){alert("Something went wrong."),console.error(a)}})},e=0,f=function(){return e++,e>25?d():void(window.S3_CONFIG_LOADED?d():setTimeout(f,25))};f()});