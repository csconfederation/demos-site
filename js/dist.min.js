function File(a,b,c){var d=b.find("Key").text().replace(/\/$/,""),e=d.substring(a.length),f=parseInt(b.find("Size").text());return{icon:"ion-document-text",name:e,title:e.replace(/^The\s*/i,""),href:c+encodeURIComponent(d),date:new Date(b.find("LastModified").text()).toLocaleString(),size:f,sizeStr:f.toBytes()}}function Directory(a){var b=a.find("Prefix").text().replace(/\/$/,""),c=b.split("/").slice(-2).join("/");return{icon:"ion-ios7-folder",name:c,title:c.replace(/^The\s*/i,""),href:location.pathname+"?path="+encodeURIComponent(b),sizeStr:"-"}}function ParentDirectory(a){var b=a.replace(/\/$/,"").split("/").slice(0,-1).concat("").join("/");return{icon:"ion-arrow-return-left",name:"../",href:location.pathname+"?path="+encodeURIComponent(b)}}Number.prototype.toBytes=function(){if(0===this)return"0 bytes";var a=parseInt(Math.floor(Math.log(this)/Math.log(1024))),b=Math.round(this/Math.pow(1024,a)*10)/10;return[b,["bytes","KB","MB","GB","TB"][a]].join(" ")},Array.prototype.sortBy=function(a,b){var c="asc"===b;return this.sort(function(b,d){return b[a]<d[a]?c?1:-1:b[a]>d[a]?c?-1:1:0})};var decrypt=function(a,b){try{var c=CryptoJS.AES.decrypt(a,b);return c.toString(CryptoJS.enc.Utf8)}catch(d){}},FileList={dirs:[],files:[],processXML:function(a){var b=this;b.prefix=a.find("Prefix:first").text(),a.find("CommonPrefixes").each(function(a,c){b.dirs.push(new Directory($(c)))}),a.find("Contents").each(function(a,c){b.files.push(new File(b.prefix,$(c),b.root))})},renderRow:function(a){for(var b,c=this.template;b=/{{(\w+)}}/.exec(c);)c=c.replace(b[0],a[b[1]]||"");return c},sortBy:function(a,b){this.files=this.files.sortBy(a,b),this.dirs=this.dirs.sortBy("title","desc")},render:function(a){this.template=$("#rowTemplate").text(),a.html("").parent().show(),this.prefix&&a.append(this.renderRow(new ParentDirectory(this.prefix))),this.dirs.forEach(function(b){b.name&&a.append(this.renderRow(b))},this),this.files.forEach(function(b){b.name&&a.append(this.renderRow(b))},this)}},KeyStore={setCookie:function(a){document.cookie="decryptKey="+a+"; path=/"},readCookie:function(){for(var a="decryptKey=",b=document.cookie.split(";"),c=0;c<b.length;c++){for(var d=b[c];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null},eraseCookie:function(){var a="expires="+new Date(0).toUTCString();document.cookie="decryptKey=;"+a+"; path=/"}},buildS3Url=function(a,b){var c=a+"?delimiter=/",d=location.search.match(/.*[?&]path=([^&]+)(&.*)?$/);return d&&(c+="&prefix="+d[1].replace(/\/$/,"")+"/"),b&&(c+="&marker="+b),c},loadS3Bucket=function(a,b,c){$("#loading").append("."),a?$.get(buildS3Url(a,c)).done(function(c){var d=$(c);FileList.processXML(d);var e=d.find("IsTruncated").text();if("false"===e)b.success();else{var f=d.find("ListBucketResult").children(":last").find("Key, Prefix").text();loadS3Bucket(a,b,f)}}).fail(b.failure):b.failure()};$(function(a){var b=function(){a("#loading, #login").hide(),a(".sortable.active").click()};a(".sortable").click(function(b){var c=a(this),d=c.attr("data-dir");FileList.sortBy(c.attr("data-field"),d),FileList.render(a("#items tbody")),a(".sortable").removeClass("active"),c.addClass("active"),c.attr("data-dir","asc"===d?"desc":"asc")}),a("#login").submit(function(d){var e=a(this).find("input").val(),f=decrypt(window.SECRET_BUCKET_URL,e);return a("#login").hide(),a("#loading").show(),FileList.root=f,loadS3Bucket(f,{success:function(){KeyStore.setCookie(e),b(f)},failure:function(a){alert("Incorrect Password"),c()}}),!1});var c=function(){if(window.SECRET_BUCKET_URL)if(KeyStore.readCookie()){var d=decrypt(window.SECRET_BUCKET_URL,KeyStore.readCookie());FileList.root=d,loadS3Bucket(d,{success:function(){b()},failure:function(a){KeyStore.eraseCookie(),c()}})}else a("#loading").hide(),a("#login").show().find("input").focus();else FileList.root=window.S3_BUCKET_URL,loadS3Bucket(window.S3_BUCKET_URL,{success:function(){b()},failure:function(a){alert("Something went wrong."),console.error(a)}})},d=0,e=function(){return d++,d>25?c():void(window.S3_CONFIG_LOADED?c():setTimeout(e,25))};e()});